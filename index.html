<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Back Home AR â€” MindAR (prompt + gated audio)</title>

  <!-- Versions that work well together -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.3.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; height:100%; overflow:hidden; background:transparent; }
    #overlay {
      position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.6); color:#fff; z-index:9999; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }
    #overlay button {
      margin-top:12px; background:#1976d2; color:#fff; border:0; border-radius:10px; padding:12px 18px; font-weight:700; font-size:16px;
    }
    #status { margin-top:8px; font-size:12px; opacity:.85; }
  </style>

  <!-- Color+Alpha matte shader -->
  <script>
    AFRAME.registerShader('video-matte', {
      schema: { videoColor:{type:'map',is:'uniform'}, videoAlpha:{type:'map',is:'uniform'}, opacity:{type:'number',default:1,is:'uniform'} },
      vertexShader: `varying vec2 vUV; void main(){ vUV=uv; gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0); }`,
      fragmentShader: `
        precision highp float; varying vec2 vUV; uniform sampler2D videoColor, videoAlpha; uniform float opacity;
        void main(){ vec4 c=texture2D(videoColor,vUV); float a=texture2D(videoAlpha,vUV).r; a=smoothstep(0.15,0.95,a)*opacity; gl_FragColor=vec4(c.rgb,a); }
      `
    });
  </script>
</head>

<body>
  <div id="overlay">
    <div>ðŸ”Š Tap to grant camera access and start AR</div>
    <button id="startBtn">Grant Camera Permission & Start</button>
    <div id="status"></div>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: https://raw.githack.com/alevalve/AR_Crab_Backhome/main/targets.mind; autoStart: false"
    vr-mode-ui="enabled: false"
    renderer="antialias: true; alpha: true; colorManagement: true; physicallyCorrectLights: true"
    embedded
  >
    <a-assets>
      <video id="videoColor"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Color.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      <video id="videoAlpha"
             src="https://raw.githack.com/alevalve/AR_Crab_Backhome/main/AR_Video02_Alpha.mp4"
             loop muted playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <!-- Target 0 -->
    <a-entity id="markerTarget" mindar-image-target="targetIndex: 0">
      <a-plane id="videoPlane"
        width="1.2" height="0.67"
        rotation="-90 0 0" position="0 0 0"
        visible="false"
        material="shader: video-matte; videoColor: #videoColor; videoAlpha: #videoAlpha; transparent: true; depthWrite: false">
      </a-plane>
    </a-entity>

    <a-camera look-controls="enabled:false"></a-camera>
  </a-scene>

  <script>
    const overlay   = document.getElementById('overlay');
    const btn       = document.getElementById('startBtn');
    const statusEl  = document.getElementById('status');
    const sceneEl   = document.querySelector('a-scene');
    const vc        = document.getElementById('videoColor');
    const va        = document.getElementById('videoAlpha');
    const targetEl  = document.getElementById('markerTarget');
    const plane     = document.getElementById('videoPlane');

    let mindarSystem = null;

    // Wait until a-scene + systems (incl. MindAR) are initialized
    sceneEl.addEventListener('loaded', () => {
      mindarSystem = sceneEl.systems['mindar-image-system'];
      if (!mindarSystem) {
        statusEl.textContent = 'âŒ MindAR system not ready (script failed or version mismatch).';
      } else {
        statusEl.textContent = 'Ready to start ðŸ“±';
      }
    });

    // Helpful logs
    sceneEl.addEventListener('arReady', () => { statusEl.textContent = 'AR is ready âœ… (camera started)'; });
    sceneEl.addEventListener('arError',  (e) => { statusEl.textContent = 'AR error âŒ (see console)'; console.error(e); });

    // Donâ€™t autoplay on load; weâ€™ll only play after targetFound
    vc.pause(); va.pause();
    vc.muted = true;

    // Start MindAR (this triggers the camera permission prompt)
    btn.addEventListener('click', async () => {
      try {
        if (!mindarSystem) throw new Error('MindAR system not initialized yet.');
        await mindarSystem.start();
        overlay.style.display = 'none';
      } catch (err) {
        console.error('Start failed:', err);
        statusEl.textContent = `âŒ ${err.message}`;
      }
    });

    // Play/stop when the marker is tracked
    targetEl.addEventListener('targetFound', async () => {
      plane.setAttribute('visible', true);
      vc.muted = false;  // gesture already happened on Start
      try { await vc.play(); } catch {}
      try { await va.play(); } catch {}
    });

    targetEl.addEventListener('targetLost', () => {
      plane.setAttribute('visible', false);
      vc.pause(); va.pause();
      vc.muted = true;
      vc.currentTime = 0; va.currentTime = 0;
    });
  </script>
</body>
</html>
